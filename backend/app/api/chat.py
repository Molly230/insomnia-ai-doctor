from flask import Blueprint, request, jsonify
import uuid
import datetime
import re

chat_bp = Blueprint('chat', __name__)

class TCMChatBot:
    """åŸºäºè§„åˆ™çš„ä¸­åŒ»æ™ºèƒ½é—®ç­”æœºå™¨äºº"""
    
    # ä¸­åŒ»å¤±çœ ç›¸å…³çš„çŸ¥è¯†åº“
    KNOWLEDGE_BASE = {
        "å¤±çœ åŸå› ": {
            "keywords": ["å¤±çœ ", "ç¡ä¸ç€", "å…¥ç¡å›°éš¾", "å¤œé†’", "æ—©é†’"],
            "response": """å¤±çœ çš„ä¸­åŒ»ç—…å› ä¸»è¦åŒ…æ‹¬ï¼š

ğŸ”¹ **æƒ…å¿—å› ç´ **ï¼šæ€è™‘è¿‡åº¦ã€å¿§æ„æ¼æ€’ã€ç²¾ç¥ç´§å¼ 
ğŸ”¹ **é¥®é£Ÿå› ç´ **ï¼šæš´é¥®æš´é£Ÿã€è¿‡é£Ÿè‚¥ç”˜åšå‘³
ğŸ”¹ **åŠ³é€¸å› ç´ **ï¼šåŠ³å¿ƒè¿‡åº¦ã€æˆ¿äº‹ä¸èŠ‚
ğŸ”¹ **ç—…åä½“è™š**ï¼šä¹…ç—…è€—ä¼¤æ°”è¡€é˜´æ¶²

**ä¸­åŒ»è®¤ä¸ºå¤±çœ ä¸»è¦ç”±"å¿ƒç¥å¤±å…»"æˆ–"å¿ƒç¥ä¸å®‰"å¯¼è‡´ã€‚**"""
        },
        
        "è¯å‹åˆ†ç±»": {
            "keywords": ["è¯å‹", "è¾¨è¯", "åˆ†å‹", "ç±»å‹"],
            "response": """ä¸­åŒ»å°†å¤±çœ åˆ†ä¸ºä»¥ä¸‹ä¸»è¦è¯å‹ï¼š

ğŸŸ¡ **è‚éƒè‚¾è™šå‹**ï¼šæƒ…ç»ªä½è½ã€è…°è†é…¸è½¯
ğŸŸ¡ **æ°”è¡€ä¸¤è™šå‹**ï¼šé¢è‰²èé»„ã€å¿ƒæ‚¸å¥å¿˜  
ğŸŸ¡ **é˜´è™šç«æ—ºå‹**ï¼šäº”å¿ƒçƒ¦çƒ­ã€ç›—æ±—å£å¹²
ğŸŸ¡ **è„¾è‚¾é˜³è™šå‹**ï¼šç•å¯’æ€•å†·ã€ç²¾ç¥èé¡
ğŸŸ¡ **è‚éƒè„¾è™šå‹**ï¼šæƒ…ç»ªæ³¢åŠ¨ã€æ¶ˆåŒ–ä¸è‰¯
ğŸŸ¡ **ç˜€è¡€å†…é˜»å‹**ï¼šèƒ¸é—·ç—›ã€èˆŒè´¨ç´«æš—

**å»ºè®®é€šè¿‡ä¸“ä¸šé—®å·è¿›è¡Œç²¾ç¡®è¾¨è¯ï¼**"""
        },
        
        "ç©´ä½æ²»ç–—": {
            "keywords": ["ç©´ä½", "æŒ‰æ‘©", "é’ˆç¸", "æ¨æ‹¿", "å¤–æ²»"],
            "response": """å¤±çœ å¸¸ç”¨ç©´ä½æ²»ç–—ï¼š

ğŸ¯ **åŸºç¡€ç©´ä½**ï¼ˆæ‰€æœ‰å¤±çœ éƒ½å¯ç”¨ï¼‰ï¼š
â€¢ **ç¥é—¨**ï¼šå®‰ç¥å®šå¿—ï¼Œæ¯æ—¥æŒ‰æ‘©5-10åˆ†é’Ÿ
â€¢ **ä¸‰é˜´äº¤**ï¼šè°ƒç†è„¾è‚¾ï¼Œç¡å‰æŒ‰æ‘©
â€¢ **æ¶Œæ³‰**ï¼šå¼•ç«å½’å…ƒï¼Œæ¸©æ°´æ³¡è„šåæŒ‰æ‘©

ğŸ¯ **è¾¨è¯é…ç©´**ï¼š
â€¢ å¿ƒè‚¾ä¸äº¤ï¼šåŠ å¿ƒä¿ã€è‚¾ä¿
â€¢ è‚éƒåŒ–ç«ï¼šåŠ å¤ªå†²ã€è¡Œé—´
â€¢ è„¾èƒƒä¸å’Œï¼šåŠ è¶³ä¸‰é‡Œã€ä¸­è„˜

**æŒ‰æ‘©æ–¹æ³•**ï¼šç”¨æ‹‡æŒ‡æŒ‡è…¹æŒ‰å‹ï¼Œæ¯ä¸ªç©´ä½1-2åˆ†é’Ÿï¼Œä»¥æœ‰é…¸èƒ€æ„Ÿä¸ºåº¦ã€‚"""
        },
        
        "é£Ÿç–—å»ºè®®": {
            "keywords": ["é£Ÿç–—", "é¥®é£Ÿ", "åƒä»€ä¹ˆ", "é£Ÿç‰©", "è¥å…»"],
            "response": """å¤±çœ çš„é£Ÿç–—è°ƒç†ï¼š

ğŸµ **å®‰ç¥èŒ¶é¥®**ï¼š
â€¢ é…¸æ£ä»èŒ¶ï¼šå…»å¿ƒå®‰ç¥
â€¢ ç™¾åˆè²å­èŒ¶ï¼šæ¸…å¿ƒæ¶¦ç‡¥
â€¢ ç«ç‘°èŠ±èŒ¶ï¼šç–è‚è§£éƒ

ğŸ¥£ **é£Ÿç–—æ–¹**ï¼š
â€¢ å°ç±³çº¢æ£ç²¥ï¼šå¥è„¾å®‰ç¥
â€¢ è²å­ç™¾åˆæ±¤ï¼šæ¸…å¿ƒé™¤çƒ¦
â€¢ é“¶è€³è²å­ç¾¹ï¼šæ»‹é˜´æ¶¦ç‡¥

âš ï¸ **é¥®é£Ÿç¦å¿Œ**ï¼š
â€¢ é¿å…æ™šé¤è¿‡é¥±
â€¢ å°‘åƒè¾›è¾£åˆºæ¿€é£Ÿç‰©
â€¢ æˆ’çƒŸé…’ã€å°‘å–æµ“èŒ¶å’–å•¡
â€¢ ç¡å‰3å°æ—¶é¿å…å¤§é‡è¿›é£Ÿ"""
        },
        
        "ç”Ÿæ´»è°ƒç†": {
            "keywords": ["ç”Ÿæ´»", "ä½œæ¯", "ä¹ æƒ¯", "è°ƒç†", "å…»ç”Ÿ"],
            "response": """å¤±çœ çš„ç”Ÿæ´»è°ƒç†è¦ç‚¹ï¼š

ğŸŒ™ **ä½œæ¯è°ƒèŠ‚**ï¼š
â€¢ å›ºå®šç¡çœ æ—¶é—´ï¼Œå»ºç«‹ç”Ÿç‰©é’Ÿ
â€¢ æ™šä¸Š9-11ç‚¹å…¥ç¡æœ€ä½³
â€¢ é¿å…ç™½å¤©é•¿æ—¶é—´åˆç¡

ğŸ§˜ **æƒ…å¿—è°ƒæ‘„**ï¼š
â€¢ ä¿æŒå¿ƒæƒ…èˆ’ç•…ï¼Œé¿å…è¿‡åº¦ç„¦è™‘
â€¢ ç¡å‰å†¥æƒ³æˆ–æ·±å‘¼å¸æ”¾æ¾
â€¢ å­¦ä¼šé‡Šæ”¾å‹åŠ›

ğŸƒ **è¿åŠ¨é”»ç‚¼**ï¼š
â€¢ é€‚é‡æœ‰æ°§è¿åŠ¨ï¼Œå¦‚æ•£æ­¥ã€å¤ªæ
â€¢ é¿å…ç¡å‰æ¿€çƒˆè¿åŠ¨
â€¢ åšæŒè§„å¾‹è¿åŠ¨ä¹ æƒ¯

ğŸ›ï¸ **ç¡çœ ç¯å¢ƒ**ï¼š
â€¢ ä¿æŒå§å®¤å®‰é™ã€é»‘æš—ã€å‡‰çˆ½
â€¢ é€‰æ‹©èˆ’é€‚çš„åºŠå“
â€¢ é¿å…åœ¨åºŠä¸Šçœ‹æ‰‹æœºã€ç”µè§†"""
        },
        
        "ç”¨è¯æŒ‡å¯¼": {
            "keywords": ["è¯ç‰©", "ä¸­è¯", "è¥¿è¯", "å®‰çœ è¯", "å‰¯ä½œç”¨"],
            "response": """å…³äºå¤±çœ ç”¨è¯çš„å»ºè®®ï¼š

ğŸ’Š **è¥¿è¯ä½¿ç”¨**ï¼š
â€¢ å®‰çœ è¯åªèƒ½çŸ­æœŸä½¿ç”¨
â€¢ é•¿æœŸä¾èµ–ä¼šäº§ç”Ÿè€è¯æ€§
â€¢ å¿…é¡»åœ¨åŒ»ç”ŸæŒ‡å¯¼ä¸‹ä½¿ç”¨

ğŸŒ¿ **ä¸­è¯è°ƒç†**ï¼š
â€¢ éœ€è¦æ ¹æ®è¯å‹é€‰æ‹©æ–¹å‰‚
â€¢ å¸¸ç”¨æ–¹ï¼šç”˜éº¦å¤§æ£æ±¤ã€é…¸æ£ä»æ±¤ç­‰
â€¢ å»ºè®®æ‰¾ä¸“ä¸šä¸­åŒ»å¸ˆå¼€æ–¹

âš ï¸ **é‡è¦æé†’**ï¼š
â€¢ ä¸å¯è‡ªè¡Œéšæ„ç”¨è¯
â€¢ ä»»ä½•è¯ç‰©éƒ½å¯èƒ½æœ‰å‰¯ä½œç”¨
â€¢ ä¸­è¥¿åŒ»ç»“åˆæ•ˆæœæ›´å¥½
â€¢ ä¸¥é‡å¤±çœ è¯·åŠæ—¶å°±åŒ»"""
        },
        
        "é»˜è®¤å›å¤": {
            "keywords": [],
            "response": """æˆ‘æ˜¯æ‚¨çš„ä¸­åŒ»å¥åº·é¡¾é—®ï¼Œä¸“æ³¨äºå¤±çœ ç›¸å…³çš„å¥åº·æŒ‡å¯¼ã€‚

æ‚¨å¯ä»¥å’¨è¯¢ä»¥ä¸‹å†…å®¹ï¼š
ğŸ”¸ å¤±çœ çš„åŸå› å’Œè¯å‹
ğŸ”¸ ç©´ä½æŒ‰æ‘©å’Œé’ˆç¸æ²»ç–—
ğŸ”¸ é£Ÿç–—å’Œç”Ÿæ´»è°ƒç†
ğŸ”¸ ç”¨è¯æŒ‡å¯¼å’Œæ³¨æ„äº‹é¡¹

å¦‚éœ€ç²¾ç¡®çš„è¯å‹åˆ¤æ–­ï¼Œå»ºè®®æ‚¨å®Œæˆæˆ‘ä»¬çš„ä¸“ä¸šé—®å·è¯Šæ–­ã€‚

**âš ï¸ é‡è¦æé†’ï¼šä»¥ä¸Šå»ºè®®ä»…ä¾›å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç”Ÿè¯Šæ–­ï¼Œå¦‚æœ‰ä¸¥é‡ç—‡çŠ¶è¯·åŠæ—¶å°±åŒ»ï¼**"""
        }
    }
    
    @classmethod
    def get_response(cls, user_message: str) -> str:
        """æ ¹æ®ç”¨æˆ·è¾“å…¥è¿”å›ç›¸åº”çš„å›å¤"""
        user_message = user_message.lower().strip()
        
        # éå†çŸ¥è¯†åº“ï¼ŒåŒ¹é…å…³é”®è¯
        for topic, data in cls.KNOWLEDGE_BASE.items():
            if topic == "é»˜è®¤å›å¤":
                continue
                
            keywords = data["keywords"]
            for keyword in keywords:
                if keyword in user_message:
                    return data["response"]
        
        # å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œè¿”å›é»˜è®¤å›å¤
        return cls.KNOWLEDGE_BASE["é»˜è®¤å›å¤"]["response"]

@chat_bp.route('/message', methods=['POST'])
def send_message():
    """å¤„ç†èŠå¤©æ¶ˆæ¯"""
    try:
        data = request.get_json()
        
        if not data or 'message' not in data:
            return jsonify({
                'success': False,
                'error': 'è¯·æä¾›æ¶ˆæ¯å†…å®¹'
            }), 400
        
        user_message = data['message'].strip()
        user_id = data.get('userId', 'anonymous')
        conversation_id = data.get('conversationId', str(uuid.uuid4()))
        
        if not user_message:
            return jsonify({
                'success': False,
                'error': 'æ¶ˆæ¯ä¸èƒ½ä¸ºç©º'
            }), 400
        
        # ä½¿ç”¨ä¸­åŒ»çŸ¥è¯†æœºå™¨äººç”Ÿæˆå›å¤
        bot_response = TCMChatBot.get_response(user_message)
        
        # ç”Ÿæˆå›å¤æ¶ˆæ¯
        response_message = {
            'id': str(uuid.uuid4()),
            'content': bot_response,
            'timestamp': datetime.datetime.now().isoformat(),
            'role': 'assistant'
        }
        
        return jsonify({
            'success': True,
            'data': {
                'message': response_message,
                'conversationId': conversation_id,
                'userId': user_id
            }
        })
        
    except Exception as e:
        return jsonify({
            'success': False,
            'error': f'å¤„ç†æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}'
        }), 500

@chat_bp.route('/health', methods=['GET'])
def health_check():
    """å¥åº·æ£€æŸ¥æ¥å£"""
    return jsonify({
        'success': True,
        'message': 'ä¸­åŒ»æ™ºèƒ½åŠ©æ‰‹æœåŠ¡æ­£å¸¸',
        'timestamp': datetime.datetime.now().isoformat()
    })

@chat_bp.route('/knowledge', methods=['GET'])
def get_knowledge_topics():
    """è·å–çŸ¥è¯†åº“ä¸»é¢˜"""
    topics = []
    for topic, data in TCMChatBot.KNOWLEDGE_BASE.items():
        if topic != "é»˜è®¤å›å¤":
            topics.append({
                'topic': topic,
                'keywords': data['keywords']
            })
    
    return jsonify({
        'success': True,
        'data': {
            'topics': topics,
            'total': len(topics)
        }
    })